# 🎵 콘서트 예약 시스템 부하 테스트 계획서

## 📋 목차
1. [테스트 개요](#테스트-개요)
2. [테스트 대상 선정](#테스트-대상-선정)
3. [테스트 시나리오](#테스트-시나리오)
4. [인프라 및 환경 구성](#인프라-및-환경-구성)
5. [모니터링 지표](#모니터링-지표)
6. [성공 기준](#성공-기준)

---

## 📊 테스트 개요

### 🎯 테스트 목적
- **성능 한계 측정**: 각 API의 처리 한계점(TPS) 파악
- **병목 지점 식별**: 시스템 내 성능 저하 구간 발견
- **안정성 검증**: 고부하 상황에서의 시스템 안정성 확인
- **용량 계획 수립**: 운영 환경 인프라 스펙 결정 근거 마련
- **장애 대응**: 예상 장애 시나리오 검증 및 복구 시간 측정

### 🏢 비즈니스 배경
콘서트 예약 서비스는 **특정 시점에 급격한 트래픽 증가**가 발생하는 전형적인 특성을 가지고 있습니다.
- 인기 아티스트 티켓 오픈 시 **수십만 명이 동시 접속**
- 제한된 좌석으로 인한 **높은 경합성**
- 결제까지 완료해야 하는 **복잡한 트랜잭션 플로우**

이러한 특성으로 인해 **사전 부하 테스트를 통한 시스템 검증**이 필수적입니다.

---

## 🎯 테스트 대상 선정

### 🔥 우선순위 1: 대기열 시스템 (Queue System)
**선정 이유:**
- 모든 사용자가 **최초 진입**하는 관문
- **Redis 기반 분산 대기열**로 메모리 사용량이 급증
- 대기열 순서 오류 시 **사용자 경험 크게 저하**

**핵심 검증 포인트:**
- 동시 토큰 발급 처리 능력
- Redis 메모리 사용량 한계
- 대기열 순서 정확성 유지

### ⚡ 우선순위 2: 좌석 예약 시스템 (Reservation System)
**선정 이유:**
- **한정된 자원(좌석)에 대한 동시 경합**
- DB 레벨의 **비관적 락** 사용으로 성능 영향
- **데이터 정합성**이 절대적으로 중요 (중복 예약 방지)

**핵심 검증 포인트:**
- 동시 예약 요청 처리 능력
- DB Connection Pool 고갈 방지
- 락 대기 시간으로 인한 타임아웃 발생 여부

### 💳 우선순위 3: 결제 시스템 (Payment System)
**선정 이유:**
- **금전 거래**로 오류 시 직접적인 손실 발생
- 외부 결제 서비스 연동으로 **네트워크 지연** 요소 존재
- 결제 실패 시 **보상 트랜잭션** 처리 복잡도

**핵심 검증 포인트:**
- 결제 요청 처리 성공률
- 결제 실패 시 롤백 정확성
- 외부 API 의존성으로 인한 타임아웃 처리

### 📨 우선순위 4: Kafka 이벤트 시스템
**선정 이유:**
- **비동기 처리**로 사용자 응답성에 직접 영향은 적음
- 하지만 **이벤트 유실 시 데이터 불일치** 발생 가능
- Consumer Lag 증가로 **실시간성 저하**

**핵심 검증 포인트:**
- 초당 이벤트 발행 처리 능력
- Consumer Lag 증가 패턴
- 메시지 유실 방지 메커니즘

---

## 🧪 테스트 시나리오

### 📈 시나리오 1: 대기열 폭증 테스트 (Peak Load Test)
```
🎯 목표: 인기 콘서트 티켓 오픈 시뮬레이션
📊 부하 패턴:
  - 0-2분: 100명 → 1,000명 (완만한 증가)
  - 2-5분: 1,000명 → 10,000명 (급격한 증가)
  - 5-15분: 10,000명 유지 (피크 유지)
  - 15-20분: 10,000명 → 1,000명 (감소)

🔍 측정 지표:
  - 토큰 발급 TPS (Target: 5,000 TPS)
  - 토큰 발급 응답 시간 (Target: P95 < 500ms)
  - Redis 메모리 사용량 (Target: < 80%)
  - 대기열 순서 정확성 (Target: 100%)

⚠️ 실패 조건:
  - 토큰 발급 실패율 > 1%
  - 응답 시간 P95 > 1초
  - 대기열 순서 뒤바뀜 발생
```

### 🥊 시나리오 2: 좌석 경합 테스트 (Concurrency Stress Test)
```
🎯 목표: 제한된 좌석에 대한 동시 예약 시뮬레이션
📊 부하 패턴:
  - 50석 콘서트에 1,000명이 동시 예약 시도
  - 지속 시간: 10분
  - 예약 시도 간격: 1-3초 랜덤

🔍 측정 지표:
  - 예약 성공률 (Target: 50/1000 = 5%)
  - 예약 응답 시간 (Target: P95 < 2초)
  - DB Lock 대기 시간 (Target: 평균 < 100ms)
  - 중복 예약 발생 여부 (Target: 0건)

⚠️ 실패 조건:
  - 중복 예약 1건이라도 발생
  - DB 커넥션 풀 고갈로 인한 에러
  - 예약 응답 시간 P95 > 5초
```

### 💰 시나리오 3: 결제 폭증 테스트 (Transaction Load Test)
```
🎯 목표: 대량 결제 처리 검증
📊 부하 패턴:
  - 동시 사용자: 5,000명
  - 지속 시간: 20분
  - 결제 성공률: 95% (의도적 실패 5% 포함)

🔍 측정 지표:
  - 결제 처리 TPS (Target: 1,000 TPS)
  - 결제 응답 시간 (Target: P95 < 3초)
  - 결제 성공률 (Target: > 95%)
  - 잔액 차감 정확성 (Target: 100%)

⚠️ 실패 조건:
  - 결제 성공률 < 90%
  - 잔액 불일치 1건이라도 발생
  - 결제 응답 시간 P99 > 10초
```

### 🌊 시나리오 4: 종합 시나리오 (End-to-End Load Test)
```
🎯 목표: 실제 사용자 여정 전체 검증
📊 사용자 여정:
  1. 대기열 토큰 발급 (10,000명)
  2. 대기열 통과 (1,000명)
  3. 좌석 조회 및 선택 (1,000명)
  4. 좌석 예약 시도 (1,000명)
  5. 결제 진행 (예약 성공자)

🔍 측정 지표:
  - 전체 여정 완료율
  - 각 단계별 이탈률
  - 시스템 전체 처리량
  - 에러 발생 패턴 분석

⚠️ 실패 조건:
  - 전체 여정 완료율 < 80%
  - 특정 단계 에러율 > 5%
```

---

## 🏗️ 인프라 및 환경 구성

### 🖥️ 테스트 환경 스펙

#### **애플리케이션 서버**
```
Base Spec:
- CPU: 4 Core (Intel Xeon)
- Memory: 8GB
- Storage: SSD 100GB

Docker 제한 설정:
- CPU Limit: 2 Core
- Memory Limit: 4GB
- 목적: 실제 운영 환경 제약 시뮬레이션
```

#### **데이터베이스**
```
MySQL 8.0:
- CPU: 8 Core
- Memory: 16GB
- Connection Pool: 최대 50개
- InnoDB Buffer Pool: 12GB

설정 최적화:
- innodb_buffer_pool_size: 12GB
- max_connections: 200
- innodb_lock_wait_timeout: 5
```

#### **Redis (대기열)**
```
Redis 7.0:
- Memory: 8GB
- Persistence: RDB + AOF
- Max Memory Policy: allkeys-lru

설정:
- maxmemory: 6GB
- timeout: 300 (5분)
```

#### **Kafka 클러스터**
```
3 Broker 구성:
- 각 Broker Memory: 4GB
- JVM Heap: 2GB
- Log Retention: 7일

Topic 설정:
- Partition: 3개
- Replication Factor: 3
- Min In-Sync Replicas: 2
```

### 🔧 부하 테스트 도구

#### **K6 (Load Testing)**

#### **모니터링 스택**
```
Grafana + Prometheus:
- 실시간 메트릭 수집
- 알림 설정
- 대시보드 구성

Kafka Manager:
- Consumer Lag 모니터링
- Topic/Partition 상태 확인
```

---

## 📊 모니터링 지표

### 🎯 핵심 성능 지표 (KPI)

#### **응답 시간 (Response Time)**
```
목표 기준:
- P50 (중간값): < 200ms
- P95 (95퍼센타일): < 500ms  
- P99 (99퍼센타일): < 1,000ms
- P99.9: < 3,000ms

측정 대상:
- 대기열 토큰 발급
- 좌석 예약 요청
- 결제 처리 요청
```

#### **처리량 (Throughput)**
```
목표 기준:
- 대기열 토큰 발급: 5,000 TPS
- 좌석 예약: 500 TPS
- 결제 처리: 1,000 TPS

측정 방법:
- 초당 성공한 요청 수
- 시간대별 처리량 변화
```

#### **에러율 (Error Rate)**
```
목표 기준:
- 전체 에러율: < 1%
- 4xx 에러: < 0.5%
- 5xx 에러: < 0.1%

분류:
- 400 Bad Request: 잘못된 요청
- 409 Conflict: 동시성 충돌
- 500 Internal Server Error: 서버 오류
- 503 Service Unavailable: 과부하
```

### 🖥️ 시스템 리소스 지표

#### **CPU 사용률**
```
임계값:
- 경고: 70%
- 위험: 85%
- 긴급: 95%

모니터링:
- 전체 CPU 사용률
- 프로세스별 CPU 사용률
- CPU Load Average
```

#### **메모리 사용률**
```
임계값:
- JVM Heap: < 80%
- Redis Memory: < 90%
- System Memory: < 85%

모니터링:
- Heap Memory 사용량
- GC 발생 빈도
- Redis Memory 사용량
```

#### **데이터베이스 지표**
```
Connection Pool:
- 활성 연결 수: < 40개 (최대 50개)
- 대기 중인 요청: < 10개

성능:
- 평균 쿼리 실행 시간: < 50ms
- Slow Query 발생: 0건
- Lock 대기 시간: < 100ms
```

### 📨 Kafka 모니터링 지표

#### **Consumer Lag**
```
임계값:
- 정상: < 100개
- 경고: 100-1,000개
- 위험: 1,000-10,000개
- 긴급: > 10,000개

영향도:
- 랭킹 업데이트 지연
- 알림 발송 지연
- 데이터 플랫폼 동기화 지연
```

#### **메시지 처리량**
```
Producer:
- 초당 메시지 발행량
- 발행 실패율

Consumer:
- 초당 메시지 처리량
- 처리 실패율
- 재시도 횟수
```

---

## ✅ 성공 기준

### 🎯 1차 목표 (Must Have)
```
성능 기준:
✅ 대기열 토큰 발급 TPS > 3,000
✅ 좌석 예약 TPS > 300  
✅ 결제 처리 TPS > 500
✅ 전체 에러율 < 2%
✅ P95 응답시간 < 1초

안정성 기준:
✅ 데이터 정합성 100% (중복 예약 0건)
✅ 시스템 다운타임 0분
✅ Consumer Lag < 5,000개 유지
```

### 🚀 2차 목표 (Nice to Have)
```
성능 기준:
🎯 대기열 토큰 발급 TPS > 5,000
🎯 좌석 예약 TPS > 500
🎯 결제 처리 TPS > 1,000  
🎯 전체 에러율 < 1%
🎯 P95 응답시간 < 500ms

확장성 기준:
🎯 동시 접속자 20,000명 처리
🎯 Consumer Lag < 1,000개 유지
🎯 자동 복구 시간 < 30초
```

### ❌ 실패 기준 (Red Line)
```
절대 허용 불가:
❌ 데이터 무결성 손상 (중복 예약, 잔액 오류)
❌ 시스템 완전 다운 (30초 이상)
❌ 결제 오류로 인한 금전 손실
❌ 개인정보 노출 또는 보안 이슈
❌ 복구 불가능한 데이터 손실
```

---

### 📊 서비스 품질 향상
```
가용성 개선:
- 99.9% 향상 목표
- 연간 다운타임: 43.8시간 → 8.8시간

사용자 만족도:
- 예약 실패율 감소
```


---


